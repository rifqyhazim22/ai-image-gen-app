name: Build and Release (web_dist, APK, macOS)

on:
  workflow_dispatch:
  push:
    tags:
      - "v*"

env:
  FLUTTER_VERSION: "3.38.3"
  SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
  SUPABASE_ANON_KEY: ${{ secrets.SUPABASE_ANON_KEY }}

jobs:
  web:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          channel: "stable"
      - run: flutter pub get
      - name: Build web_dist
        run: |
          flutter build web --release \
            --dart-define=SUPABASE_URL=${SUPABASE_URL} \
            --dart-define=SUPABASE_ANON_KEY=${SUPABASE_ANON_KEY}
          rm -rf web_dist
          mv build/web web_dist
          zip -r AI-Image-Gen-App-web.zip web_dist
      - uses: actions/upload-artifact@v4
        with:
          name: web_dist
          path: AI-Image-Gen-App-web.zip

  apk:
    runs-on: ubuntu-latest
    needs: web
    steps:
      - uses: actions/checkout@v4
      - uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          channel: "stable"
      - run: flutter pub get
      - name: Build APK
        run: |
          flutter build apk --release \
            --dart-define=SUPABASE_URL=${SUPABASE_URL} \
            --dart-define=SUPABASE_ANON_KEY=${SUPABASE_ANON_KEY}
          cp build/app/outputs/flutter-apk/app-release.apk AI-Image-Gen-App.apk
      - uses: actions/upload-artifact@v4
        with:
          name: apk
          path: AI-Image-Gen-App.apk

  macos:
    runs-on: macos-latest
    needs: web
    steps:
      - uses: actions/checkout@v4
      - uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          channel: "stable"
      - run: flutter pub get
      - name: Build macOS (ad-hoc sign)
        run: |
          flutter build macos --release \
            --dart-define=SUPABASE_URL=${SUPABASE_URL} \
            --dart-define=SUPABASE_ANON_KEY=${SUPABASE_ANON_KEY}
          app_path="build/macos/Build/Products/Release/AI Image Gen App.app"
          codesign --force --deep --sign - "$app_path"
          ditto -c -k --sequesterRsrc --keepParent "$app_path" AI-Image-Gen-App-mac.zip
          hdiutil create -volname "AI Image Gen App" -srcfolder "$app_path" -ov -format UDZO AI-Image-Gen-App.dmg
      - uses: actions/upload-artifact@v4
        with:
          name: macos
          path: |
            AI-Image-Gen-App-mac.zip
            AI-Image-Gen-App.dmg

  release:
    if: startsWith(github.ref, 'refs/tags/v')
    runs-on: ubuntu-latest
    needs: [web, apk, macos]
    steps:
      - uses: actions/download-artifact@v4
        with:
          name: web_dist
      - uses: actions/download-artifact@v4
        with:
          name: apk
      - uses: actions/download-artifact@v4
        with:
          name: macos
      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          files: |
            AI-Image-Gen-App-web.zip
            AI-Image-Gen-App.apk
            AI-Image-Gen-App-mac.zip
            AI-Image-Gen-App.dmg
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

